---
output: 
  pdf_document:
    toc: no
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\begin{center}
\vspace*{75pt}
\Huge \textbf{Who are the financial profiteers of war?} \\
\vspace{50pt}
\Large University of Applied Sciences Lucerne \\[10pt]
\Large Master of Science in Applied Information and Data Science \\[10pt]
\Large Time Series in Finance (TSA01) \\[10pt]
\vspace{50pt}
\Large Authors: MichÃ¨le Gerber and Damien Grossniklaus \\
\Large Date of Submission: 22. December 2023 \\
\end{center}



\newpage
```{=latex}
\setcounter{tocdepth}{4}
\tableofcontents
```
\newpage


```{r, eval=FALSE}
install.packages("readr")
install.packages("colorspace")
install.packages("vctrs")
install.packages("gtrendsR")
```


```{r, echo=FALSE, results=FALSE, message=FALSE}
library(quantmod)
library(tseries)
#library(readr) #Disable in order to Google trends package to work
library(gtrendsR)
library(lubridate)
library(ggplot2)
library(zoo)
library(dplyr)
library(tidyr)
library(vars)
```

TODO:
* Ticker Section Mentioning in Charts and Code
* Nach differencing nochmals Stationarity testen
* Casality testing andere Seite --> Einfluss Ticker auf Trends ausschliessen
* Add Inflation as Controll Variable

**Potential structure**

- Context and Goal (Literature?)
- Methods
- Data
  - Import data (indices & Google words)
  - Describe data
  - Preprocessing
- VAR & Causality Testing
- Results & Discussion


## 1. Context and Goal

With recent outbreaks of war (e.g., in Israel or in the Ukraine), the question arises of how stock markets react to this and if there are sectors that profit from such crises. Specifically, the case study should examine if certain indices from specific economic sectors perform well in situations of crisis. To do this, the performance of several sector-specific indices in relation to an overall crisis measure should be compared and evaluated with the goal of examining if positive correlations between situations of crisis and stock market profits exist. Alternatively, the research question could be evaluated by comparing the development of sector-specific indices since the outbreak of the war in the Ukraine with the development of non-sector-specific indices (like SMI or S&P 500). If they perform better than overall indices this would indicate that they profit from war.

## 2. Methods

The precise methods to examine the hypothesis are not clear yet and will have to be decided once more methods are introduced in the lectures. However, correlation measurements as well as potential tests for causality will have to be included. If we use the alternative way to answer our research question we could probably use OLS (as described in class last week).

## 3. Data


Import Time Series Data

TODO: 
- Justify why Adjusted values and not close values
- Timeframe: December 2021 until December 2023
```{r}
# Ticker Data
ticker_data <- NULL
tickers_index <- c("XLK", "XLF", "XLV", "XLY", "XLE", "XLU")

for (Ticker in tickers_index){
  ticker_data <- cbind(ticker_data,
                       getSymbols.yahoo(Ticker, from="2021-12-01", to="2023-12-01", 
                                        periodicity = "weekly",auto.assign=FALSE)[,6])
}

# Check length and min max date
length(ticker_data$XLK.Adjusted)
summary(ticker_data)[c(1, 6)]
head(ticker_data)
```


```{r}
# Google Trends data
gtrends_war_web <- gtrends(
  keyword = "war",
  time = "2021-11-30 2023-12-01",
  gprop = "web"
)$interest_over_time
gtrends_war_web
```

```{r, eval=FALSE}
# Too many requests exclude?
gtrends_war_news <- gtrends(
  keyword = "war",
  time = "2021-12-01 2023-12-01",
  gprop = "news"
)$interest_over_time
```


```{r, eval=FALSE}
# If gtrends does not work --> response 429
library(lubridate)

gtrends_war_web <- read.csv('gtrends_war_web.csv')
gtrends_war_web <- gtrends_war_web %>%
  mutate(date = ymd(date))

```



Google Trends delivers data always from Sunday weekly. This has to be put to the weekly data from the financial tickers, which always starts at Monday.

```{r}
# Increase date by one day to match ticker data
gtrends_war_web$date <- gtrends_war_web$date + days(1)

# Check length and min max date
length(gtrends_war_web$date)
min(gtrends_war_web$date)
max(gtrends_war_web$date)
```

```{r}
# Remove first date of ticker data to match gtrends data
ticker_data <- ticker_data[-1,]
ticker_data
```



### Visualize Ticker Data

```{r}
# Visualization
ticker_data_df <- fortify.zoo(ticker_data)
colnames(ticker_data_df)[1] <- "Date"
ticker_data_df <- gather(ticker_data_df, key="Ticker", value="Value", 
                         c("XLK.Adjusted", "XLF.Adjusted", "XLV.Adjusted", 
                           "XLY.Adjusted", "XLE.Adjusted", "XLU.Adjusted"), -Date)

ticker_data_df
```

```{r}
# Line Chart
ggplot(ticker_data_df, aes(Date, Value)) +
  geom_line(color='darkseagreen3') +
  facet_wrap(~Ticker) +
  ggtitle("Ticker Time Series") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

```{r}
# Histogram
ggplot(ticker_data_df, aes(Value)) +
  geom_histogram(color='darkseagreen3', fill='darkseagreen3') +
  facet_wrap(~Ticker) +
  ggtitle("Ticker Distributions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))

```


#### Visualize Google Trends Data
```{r fig.align="center", fig.width=12, fig.height=4}
# Line chart

# Convert 'date' column to POSIXct format
gtrends_war_web$date <- as.POSIXct(gtrends_war_web$date, format = "%Y-%m-%d")

ggplot(gtrends_war_web, aes(date, hits)) +
  geom_line(color='darkseagreen3') +
  theme_minimal() +
  ggtitle("Google Trends - Evolving Interest in Search Word 'War'") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = as.POSIXct("2022-02-24"), linetype="dashed", 
             color = "black", size=0.5) +
  annotate('label', x=as.POSIXct("2022-02-24"), y=80, 
           label="Start Russian Invasion of Ukraine", vjust=2, color="black") +
  geom_vline(xintercept = as.POSIXct("2023-10-07"), linetype="dashed", 
               color = "black", size=0.5) +
  annotate('label', x=as.POSIXct("2023-10-07"), y=80, 
             label="Start Israel-Hammas War", vjust=2, color="black")
  

```

```{r}
# Histogram
ggplot(gtrends_war_web, aes(hits)) +
  geom_histogram(color='darkseagreen3', fill='darkseagreen3') +
  ggtitle("Search Word 'War' Distribution") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

### Stationarity test and adjustment

Ticker Data
```{r}
# Check stationarity
sapply(ticker_data, adf.test)
```

Non-stationary are XLK, XLF, XLY, XLE. Make them stationary. Only log the others.

```{r}
ticker_data_differenced <- NULL
ticker_data_differenced$XLK.Adjusted <- na.omit(diff(log(ticker_data$XLK.Adjusted)))
ticker_data_differenced$XLF.Adjusted <- na.omit(diff(log(ticker_data$XLF.Adjusted)))
ticker_data_differenced$XLY.Adjusted <- na.omit(diff(log(ticker_data$XLY.Adjusted)))
ticker_data_differenced$XLE.Adjusted <- na.omit(diff(log(ticker_data$XLE.Adjusted)))

# Already stationary ticker series 
ticker_data_differenced$XLV.Adjusted <- log(ticker_data$XLV.Adjusted)
ticker_data_differenced$XLU.Adjusted <- log(ticker_data$XLU.Adjusted)

# For non differenced time series remove first row
ticker_data_differenced$XLV.Adjusted <-  ticker_data_differenced$XLV.Adjusted[-1,]
ticker_data_differenced$XLU.Adjusted <-  ticker_data_differenced$XLU.Adjusted[-1,]
```

Google Trends Data
```{r}
adf.test(gtrends_war_web$hits)
```

Not stationary and distribution has long tail on right --> Log Diff. Although p value is slightly below 0.05
```{r}
logged_diff_hits <- na.omit(diff(log(gtrends_war_web$hits)))

corresponding_dates <- gtrends_war_web[-1,]$date # +1 due to diff reduction

gtrends_war_web_differenced <- data.frame(
  date = corresponding_dates,
  hits = logged_diff_hits
)
gtrends_war_web_differenced
```

Check that differenced time series have same length.

```{r}
# Check length of time series
length(gtrends_war_web_differenced$date) == length(ticker_data_differenced$XLK.Adjusted)
length(gtrends_war_web_differenced$date)
length(ticker_data_differenced$XLK.Adjusted)
min(gtrends_war_web_differenced$date)
max(gtrends_war_web_differenced$date)
```


Create final dataframe
```{r}
# Make tickers in list to dataframe
ticker_data_differenced_df <- do.call(cbind.data.frame, ticker_data_differenced)

# Make date index to column for merging
ticker_data_differenced_df$date <- rownames(ticker_data_differenced_df)

# Make date in gtrends to character in order to merge
gtrends_war_web_differenced$date <- format(gtrends_war_web_differenced$date, format = "%Y-%m-%d")

# Merge
war_ticker_df <- left_join(gtrends_war_web_differenced, ticker_data_differenced_df)
```


## 4. VAR & Causality Testing

TODO:
- Check lag.max what to apply
- Control variable?

```{r}
# Create ticker list
ticker_cols <- colnames(war_ticker_df)[3:8]

for (Ticker in ticker_cols) {
  
  # Create data for VAR
  print(Ticker)
  data_for_var <- cbind(war_interest=war_ticker_df$hits, ticker=war_ticker_df[[Ticker]])
  
  # Run VAR model
  VAR_est <- VAR(data_for_var, ic = "AIC", lag.max = 24)
  coefs <-coeftest(VAR_est)
  summ <- summary(VAR_est)
  
  print(coefs)
  print(summ)
  
  # Run Granger Causality Test
  causal <- causality(VAR_est, cause="war_interest")["Granger"]
  print(causal)
  
  # Impulse response functions
  plot(irf(VAR_est, impulse="war_interest", response="ticker"))
  
}
```


## 5. Results & Discussion


